apiVersion: v1 
kind: ConfigMap 
metadata:
  name: {{ .Values.testPod.name }}-script 
  namespace: {{ .Values.app.namespace }} 
  labels:
    app: gcp-wi-demo
    {{- include "gcp-wi-app.labels" . | nindent 4 }}
data:
  test.py: |
    #!/usr/bin/env python3
    from google.cloud import storage
    import os
    import sys
    
    print("\n" + "="*60)
    print("Testing GCP Workload Identity with Config Connector") 
    print("="*60 + "\n")

    # Get configuration from environment 
    bucket_name = os.getenv("BUCKET_NAME") 
    project_id = os.getenv("GCP_PROJECT_ID")
    
    if not bucket_name:
      print(" ERROR: BUCKET_NAME environment variable not set") 
      sys.exit(1)

    print(f" Project ID: {project_id}")
    print (f" Bucket Name: {bucket_name}")
    print (f" Authentication: Workload Identity (automatic)\n")

    try:
      # Initialize GCS client (uses Workload Identity automatically) 
      print("Initializing GCS client...")
      client = storage.Client(project=project_id)

      # Get bucket
      print (f"Accessing bucket: {bucket_name}...") 
      bucket = client.bucket(bucket_name)

      # List objects
      print (f"Listing objects in bucket...\n") 
      blobs = list(bucket.list_blobs())

      if blobs:
        print (f"Successfully listed {len (blobs)} object(s):\n")
        for blob in blobs:
          print (f"-  {blob.name}")
      else:
        print("Bucket is empty (no objects found)")
      print("="*60)
      print(" SUCCESS: Workload Identity is working correctly!") 
      print("="*60 + "\n")

    except Exception as e:
      print(f"\n ERROR: {type(e).__name__}")
      print("="*60)
      sys.exit(1)